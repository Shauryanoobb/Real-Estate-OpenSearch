<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Search & List</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-4 sm:p-6">

    <div class="max-w-6xl mx-auto bg-white p-4 sm:p-8 rounded-2xl shadow-xl">
        <h1 class="text-2xl sm:text-3xl font-extrabold text-indigo-700 mb-4 sm:mb-6 border-b pb-2">üè† Real Estate Property Portal</h1>

        <div class="mb-6 sm:mb-8 flex flex-col sm:flex-row gap-3 sm:space-x-4 sm:gap-0">
            <a href="/static/add_update.html" class="bg-green-600 text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-green-700 transition duration-150 text-center">‚ûï Add New Property</a>
            <button onclick="listAllProperties()" class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">üìú List All Properties</button>
            <button onclick="toggleFilters()" class="sm:hidden bg-gray-600 text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-gray-700 transition duration-150">üîç Toggle Filters</button>
        </div>

        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4">Find Your Property</h2>
        <div id="filterPanel" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 bg-indigo-50 p-4 sm:p-6 rounded-xl mb-6 sm:mb-8">

            <!-- Basic Search -->
            <div class="col-span-full sm:col-span-2 lg:col-span-2">
                <label class="block text-xs font-medium text-gray-700 mb-1">Locality</label>
                <input id="locality" class="w-full p-2.5 sm:p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm sm:text-base" placeholder="Search by locality">
            </div>

            <div class="col-span-full sm:col-span-2 lg:col-span-2">
                <label class="block text-xs font-medium text-gray-700 mb-1">Keywords</label>
                <input id="keywords" class="w-full p-2.5 sm:p-3 border rounded-lg text-sm sm:text-base" placeholder="Description keywords">
            </div>
            
            <div class="col-span-full sm:col-span-2">
                <label class="block text-xs font-medium text-gray-700 mb-1">Title Keywords</label>
                <input id="title_keywords" class="w-full p-2.5 sm:p-3 border rounded-lg text-sm sm:text-base" placeholder="Search in title">
            </div>
            
            <!-- Property Type -->
            <div class="col-span-full sm:col-span-2 lg:col-span-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">Property Type</label>
                <select id="property_type" class="w-full p-2.5 sm:p-3 border rounded-lg text-sm sm:text-base">
                    <option value="">All Types</option>
                    <option value="Flat">Flat</option>
                    <option value="Bungalow">Bungalow</option>
                    <option value="Plot">Plot</option>
                    <option value="Office">Office</option>
                    <option value="Shop">Shop</option>
                </select>
            </div>

            <div class="col-span-full sm:col-span-1 lg:col-span-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">Furnishing</label>
                <select id="furnishing_status" class="w-full p-2.5 sm:p-3 border rounded-lg text-sm sm:text-base">
                    <option value="">Any</option>
                    <option value="FURNISHED">Furnished</option>
                    <option value="SEMI_FURNISHED">Semi-Furnished</option>
                    <option value="UNFURNISHED">Unfurnished</option>
                </select>
            </div>

            <!-- Specifications -->
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">BHK</label>
                <input id="bhk" type="number" class="w-full p-2.5 sm:p-3 border rounded-lg text-sm sm:text-base" placeholder="e.g., 2">
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Min Area (sqft)</label>
                <input id="min_sqft" type="number" class="w-full p-2.5 sm:p-3 border rounded-lg text-sm sm:text-base" placeholder="Min">
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Max Area (sqft)</label>
                <input id="max_sqft" type="number" class="w-full p-2.5 sm:p-3 border rounded-lg text-sm sm:text-base" placeholder="Max">
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Total Floors</label>
                <input id="total_floors" type="number" class="w-full p-2.5 sm:p-3 border rounded-lg text-sm sm:text-base" placeholder="Exact">
            </div>

            <!-- Price Range -->
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Min Price (‚Çπ)</label>
                <input id="min_price" type="number" class="w-full p-2.5 sm:p-3 border rounded-lg text-sm sm:text-base" placeholder="Min">
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Max Price (‚Çπ)</label>
                <input id="max_price" type="number" class="w-full p-2.5 sm:p-3 border rounded-lg text-sm sm:text-base" placeholder="Max">
            </div>

            <!-- Lift -->
            <div class="col-span-full sm:col-span-2 lg:col-span-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">Lift Available?</label>
                <select id="has_lift" class="w-full p-2.5 sm:p-3 border rounded-lg text-sm sm:text-base">
                    <option value="">Any</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            
            <!-- Action Buttons -->
            <div class="col-span-full flex flex-col sm:flex-row gap-2 sm:gap-3 mt-2">
                <button onclick="searchProperties()" class="flex-1 bg-indigo-600 text-white p-2.5 sm:p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 text-sm sm:text-base">
                    üîç Search Properties
                </button>
                <button onclick="clearFilters()" class="flex-1 sm:flex-none bg-gray-500 text-white px-4 sm:px-6 py-2.5 sm:p-3 rounded-lg font-semibold hover:bg-gray-600 transition duration-150 text-sm sm:text-base">
                    Clear Filters
                </button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-3 sm:mb-4">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Property Listings</h2>
            <span id="result_count" class="text-sm sm:text-base text-gray-600"></span>
        </div>
        
        <div id="results" class="space-y-4 sm:space-y-6">
            <p class="text-gray-500 text-sm sm:text-base" id="status_message">Use the search bar or click "List All Properties" to view listings.</p>
        </div>
    </div>

    <!-- Property Detail Modal -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-4 sm:px-6 py-4 flex justify-between items-center">
                    <h2 class="text-xl sm:text-2xl font-bold text-indigo-700">Property Details</h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                <div id="modalContent" class="p-4 sm:p-6"></div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = window.location.origin + "/api/properties";
        const resultsContainer = document.getElementById("results");
        const statusMessage = document.getElementById("status_message");
        const resultCount = document.getElementById("result_count");
        const detailModal = document.getElementById("detailModal");
        const modalContent = document.getElementById("modalContent");

        function toggleFilters() {
            const panel = document.getElementById('filterPanel');
            panel.classList.toggle('hidden');
        }

        function clearFilters() {
            document.getElementById('locality').value = '';
            document.getElementById('keywords').value = '';
            document.getElementById('title_keywords').value = '';
            document.getElementById('property_type').value = '';
            document.getElementById('furnishing_status').value = '';
            document.getElementById('bhk').value = '';
            document.getElementById('min_sqft').value = '';
            document.getElementById('max_sqft').value = '';
            document.getElementById('total_floors').value = '';
            document.getElementById('min_price').value = '';
            document.getElementById('max_price').value = '';
            document.getElementById('has_lift').value = '';
        }

        function formatPrice(price) {
            if (price >= 10000000) {
                return `‚Çπ${(price / 10000000).toFixed(2)} Cr`;
            } else if (price >= 100000) {
                return `‚Çπ${(price / 100000).toFixed(2)} L`;
            }
            return `‚Çπ${price.toLocaleString('en-IN')}`;
        }

        function renderResults(data) {
            resultsContainer.innerHTML = '';
            statusMessage.style.display = 'none';

            if (!data.hits || data.hits.hits.length === 0) {
                resultsContainer.innerHTML = '<p class="text-red-500 font-semibold text-sm sm:text-base">No properties found matching your criteria.</p>';
                resultCount.textContent = '0 properties';
                return;
            }

            const count = data.hits.hits.length;
            resultCount.textContent = `${count} ${count === 1 ? 'property' : 'properties'} found`;

            data.hits.hits.forEach(hit => {
                const p = hit._source;
                const propertyId = hit._id;
                
                const resultCard = `
                    <div class="p-4 sm:p-6 border border-gray-200 rounded-xl shadow-md bg-white hover:shadow-lg transition duration-200">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2 mb-3">
                            <div class="flex-1">
                                <h3 class="text-lg sm:text-xl font-bold text-indigo-800 break-words">${p.title}</h3>
                                <p class="text-xs sm:text-sm text-gray-500 mt-1">ID: ${propertyId}</p>
                            </div>
                            <div class="text-left sm:text-right">
                                <p class="text-xl sm:text-2xl font-extrabold text-green-600">${formatPrice(p.price)}</p>
                                ${p.property_type ? `<span class="inline-block mt-1 px-2 py-1 bg-indigo-100 text-indigo-800 text-xs font-medium rounded">${p.property_type}</span>` : ''}
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-sm sm:text-base">
                            <p class="text-gray-700">üìç <strong>${p.locality}</strong></p>
                            <div class="flex flex-wrap gap-3 text-gray-700">
                                <span>üõèÔ∏è ${p.bhk} BHK</span>
                                <span>üìê ${p.area_sqft} sqft</span>
                                <span>üõÅ ${p.bathrooms} Bath${p.bathrooms > 1 ? 's' : ''}</span>
                                ${p.floor_number ? `<span>üè¢ Floor ${p.floor_number}${p.total_floors ? `/${p.total_floors}` : ''}</span>` : ''}
                            </div>
                            
                            ${p.facing_direction ? `<p class="text-gray-600 text-sm">üß≠ Facing: ${p.facing_direction}</p>` : ''}
                            
                            <div class="flex flex-wrap gap-2 text-xs sm:text-sm text-gray-600">
                                ${p.furnishing_status ? `<span class="px-2 py-1 bg-gray-100 rounded">${p.furnishing_status}</span>` : ''}
                                ${p.lift_available !== null ? `<span class="px-2 py-1 bg-gray-100 rounded">${p.lift_available ? '‚úì' : '‚úó'} Lift</span>` : ''}
                                ${p.age_of_building ? `<span class="px-2 py-1 bg-gray-100 rounded">${p.age_of_building}yr old</span>` : ''}
                            </div>
                            
                            ${p.overlooking && p.overlooking.length > 0 ? `
                                <p class="text-sm text-gray-600">üå≥ Views: ${p.overlooking.join(', ')}</p>
                            ` : ''}
                            
                            ${p.additional_rooms && p.additional_rooms.length > 0 ? `
                                <p class="text-sm text-gray-600">‚ûï Extra: ${p.additional_rooms.join(', ')}</p>
                            ` : ''}
                            
                            ${p.description ? `<p class="text-sm text-gray-600 mt-2 line-clamp-2">${p.description}</p>` : ''}
                        </div>
                        
                        <div class="mt-4 flex flex-wrap gap-3 text-sm sm:text-base">
                            <button onclick="viewProperty('${propertyId}')" class="flex-1 sm:flex-none font-medium text-blue-600 hover:text-blue-700 hover:underline">üëÅÔ∏è View Details</button>
                            <a href="/static/add_update.html?id=${propertyId}" class="flex-1 sm:flex-none font-medium text-yellow-600 hover:text-yellow-700 hover:underline text-center sm:text-left">‚úèÔ∏è Edit</a>
                            <button onclick="deleteProperty('${propertyId}')" class="flex-1 sm:flex-none font-medium text-red-600 hover:text-red-700 hover:underline">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
                resultsContainer.innerHTML += resultCard;
            });
        }

        async function listAllProperties() {
            statusMessage.textContent = 'Fetching all properties...';
            statusMessage.style.display = 'block';
            resultsContainer.innerHTML = '';
            resultCount.textContent = '';
            
            try {
                const res = await fetch(`${BASE_URL}/?size=50`);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                renderResults(data);
            } catch (error) {
                statusMessage.textContent = `Error listing properties: ${error.message}`;
                statusMessage.className = 'text-red-500 font-semibold';
            }
        }

        async function searchProperties() {
            const params = new URLSearchParams();
            
            const fields = [
                "locality", "keywords", "title_keywords", 
                "property_type", "furnishing_status",
                "bhk", "total_floors",
                "min_sqft", "max_sqft", "min_price", "max_price",
                "has_lift"
            ];

            fields.forEach(f => {
                const value = document.getElementById(f).value;
                if (value !== "") params.append(f, value);
            });

            statusMessage.textContent = 'Searching properties...';
            statusMessage.style.display = 'block';
            resultsContainer.innerHTML = '';
            resultCount.textContent = '';

            try {
                const url = `${BASE_URL}/search/?${params.toString()}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                renderResults(data);
            } catch (error) {
                statusMessage.textContent = `Error searching properties: ${error.message}`;
                statusMessage.className = 'text-red-500 font-semibold';
            }
        }
        
        async function deleteProperty(propertyId) {
            if (!confirm(`Are you sure you want to delete this property?`)) return;

            try {
                const res = await fetch(`${BASE_URL}/${propertyId}`, { method: 'DELETE' });
                if (res.status === 404) {
                    alert('Property not found.');
                    return;
                }
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                
                alert(`Property deleted successfully.`);
                
                const hasFilters = document.getElementById('locality').value || 
                                  document.getElementById('bhk').value ||
                                  document.getElementById('property_type').value;
                
                if (hasFilters) {
                    searchProperties();
                } else {
                    listAllProperties();
                }

            } catch (error) {
                alert(`Error deleting property: ${error.message}`);
            }
        }

        async function viewProperty(propertyId) {
            try {
                const res = await fetch(`${BASE_URL}/${propertyId}`);
                if (!res.ok) throw new Error('Failed to fetch property details');
                const property = await res.json();
                
                modalContent.innerHTML = `
                    <div class="space-y-4 sm:space-y-6">
                        <div>
                            <h3 class="text-2xl sm:text-3xl font-bold text-indigo-800 mb-2">${property.title}</h3>
                            <p class="text-2xl sm:text-3xl font-extrabold text-green-600">${formatPrice(property.price)}</p>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                            <div><span class="font-semibold">Type:</span> ${property.property_type || 'N/A'}</div>
                            <div><span class="font-semibold">Locality:</span> ${property.locality}</div>
                            <div><span class="font-semibold">BHK:</span> ${property.bhk}</div>
                            <div><span class="font-semibold">Bathrooms:</span> ${property.bathrooms}</div>
                            <div><span class="font-semibold">Area:</span> ${property.area_sqft} sqft</div>
                            <div><span class="font-semibold">Facing:</span> ${property.facing_direction || 'N/A'}</div>
                            <div><span class="font-semibold">Floor:</span> ${property.floor_number || 'N/A'}${property.total_floors ? ` / ${property.total_floors}` : ''}</div>
                            <div><span class="font-semibold">Furnishing:</span> ${property.furnishing_status || 'N/A'}</div>
                            <div><span class="font-semibold">Lift:</span> ${property.lift_available ? 'Yes' : 'No'}</div>
                            <div><span class="font-semibold">Age:</span> ${property.age_of_building ? `${property.age_of_building} years` : 'N/A'}</div>
                            <div><span class="font-semibold">Listed:</span> ${property.listed_date ? new Date(property.listed_date).toLocaleDateString() : 'N/A'}</div>
                        </div>
                        
                        ${property.description ? `
                            <div>
                                <h4 class="font-semibold text-lg mb-2">Description</h4>
                                <p class="text-gray-700">${property.description}</p>
                            </div>
                        ` : ''}
                        
                        ${property.overlooking && property.overlooking.length > 0 ? `
                            <div>
                                <h4 class="font-semibold text-lg mb-2">Overlooking Views</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${property.overlooking.map(view => `<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${view}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${property.additional_rooms && property.additional_rooms.length > 0 ? `
                            <div>
                                <h4 class="font-semibold text-lg mb-2">Additional Rooms</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${property.additional_rooms.map(room => `<span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">${room}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${property.amenities && property.amenities.length > 0 ? `
                            <div>
                                <h4 class="font-semibold text-lg mb-2">Amenities</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${property.amenities.map(amenity => `<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">${amenity}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${property.seller_name || property.seller_email || property.seller_phone ? `
                            <div class="border-t pt-4">
                                <h4 class="font-semibold text-lg mb-3">Seller Information</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                                    ${property.seller_name ? `<div><span class="font-semibold">Name:</span> ${property.seller_name}</div>` : ''}
                                    ${property.seller_email ? `<div><span class="font-semibold">Email:</span> <a href="mailto:${property.seller_email}" class="text-blue-600 hover:underline">${property.seller_email}</a></div>` : ''}
                                    ${property.seller_phone ? `<div><span class="font-semibold">Phone:</span> <a href="tel:${property.seller_phone}" class="text-blue-600 hover:underline">${property.seller_phone}</a></div>` : ''}
                                    ${property.seller_referred_by ? `<div><span class="font-semibold">Referred By:</span> ${property.seller_referred_by}</div>` : ''}
                                    ${property.seller_address ? `<div class="col-span-full"><span class="font-semibold">Address:</span> ${property.seller_address}</div>` : ''}
                                    ${property.seller_additional_info ? `<div class="col-span-full"><span class="font-semibold">Notes:</span> ${property.seller_additional_info}</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                            <a href="/static/add_update.html?id=${propertyId}" class="flex-1 bg-yellow-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-yellow-600 transition duration-150 text-center">‚úèÔ∏è Edit Property</a>
                            <button onclick="deleteProperty('${propertyId}')" class="flex-1 bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 transition duration-150">üóëÔ∏è Delete Property</button>
                        </div>
                    </div>
                `;
                
                detailModal.classList.remove('hidden');
            } catch (error) {
                alert(`Error loading property details: ${error.message}`);
            }
        }

        function closeModal() {
            detailModal.classList.add('hidden');
        }

        // Close modal when clicking outside
        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) {
                closeModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !detailModal.classList.contains('hidden')) {
                closeModal();
            }
        });
        
        // Initial load
        document.addEventListener('DOMContentLoaded', listAllProperties);
    </script>

</body>
</html>