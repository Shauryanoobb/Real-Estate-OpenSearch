<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Search & List</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">

    <div class="max-w-6xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-6 border-b pb-2">üè† Real Estate Matching Portal</h1>

        <!-- Context Switcher -->
        <div class="mb-6 flex space-x-6 justify-center p-3 bg-indigo-50 rounded-lg">
            <label class="flex items-center space-x-2 font-semibold text-gray-700 cursor-pointer">
                <input type="radio" name="search_context" value="supply" checked onchange="setSearchContext('supply')" class="text-indigo-600 focus:ring-indigo-500">
                <span>Search Inventory (Supply)</span>
            </label>
            <label class="flex items-center space-x-2 font-semibold text-gray-700 cursor-pointer">
                <input type="radio" name="search_context" value="demand" onchange="setSearchContext('demand')" class="text-indigo-600 focus:ring-indigo-500">
                <span>Search Requests (Demand)</span>
            </label>
        </div>

        <div class="mb-8 flex space-x-4">
            <a href="/static/add_update.html" class="bg-green-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-150">‚ûï Add New Listing</a>
            <button onclick="listAll()" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">üìú List All</button>
        </div>

        <h2 class="text-2xl font-bold text-gray-800 mb-4">Find Listings / Requirements</h2>
        <div id="filterPanel" class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-indigo-50 p-6 rounded-xl mb-8">

            <!-- CORE FILTERS -->
            <input id="locality" class="p-3 border rounded-lg" placeholder="Locality">
            <input id="keywords" class="p-3 border rounded-lg" placeholder="Description keywords">
            <input id="title_keywords" class="p-3 border rounded-lg" placeholder="Title keywords">
            
            <select id="property_type" class="p-3 border rounded-lg">
                <option value="">Property Type</option>
                <option value="Flat">Flat</option>
                <option value="Bungalow">Bungalow</option>
                <option value="Plot">Plot</option>
                <option value="Office">Office</option>
                <option value="Shop">Shop</option>
                <option value="Agricultural Land">Agricultural Land</option>
                <option value="Industrial Land">Industrial Land</option>
            </select>
            
            <select id="listing_type" class="p-3 border rounded-lg">
                <option value="">Listing Type</option>
                <option value="SALE">Sale</option>
                <option value="RENT">Rent</option>
            </select>

            <select id="furnishing_status" class="p-3 border rounded-lg">
                <option value="">Furnishing Status</option>
                <option value="FURNISHED">FURNISHED</option>
                <option value="SEMI_FURNISHED">SEMI-FURNISHED</option>
                <option value="UNFURNISHED">UNFURNISHED</option>
            </select>

            <!-- DYNAMIC SPECIFICATION INPUTS CONTAINER -->
            <div id="spec_fields" class="col-span-full grid grid-cols-4 gap-4">
                <!-- Content injected here by JavaScript (e.g., price, bhk, sqft inputs) -->
            </div>
            
            <button onclick="search()" class="col-span-full md:col-span-2 bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">
                Search
            </button>
        </div>

        <h2 class="text-2xl font-bold text-gray-800 mt-6 mb-4" id="listing_header">Inventory Listings:</h2>
        <div id="results" class="space-y-6">
            <p class="text-gray-500" id="status_message">Select a context and start searching.</p>
        </div>
    </div>

    <script>
        const BASE_URL = window.location.origin + "/api";
        let currentSearchContext = 'supply'; // Default context

        const resultsContainer = document.getElementById("results");
        const statusMessage = document.getElementById("status_message");
        const specFieldsContainer = document.getElementById("spec_fields");
        const listingHeader = document.getElementById("listing_header");

        function formatPrice(price) {
            if (!price) return 'N/A';
            if (price >= 10000000) {
                return `‚Çπ${(price / 10000000).toFixed(2)} Cr`;
            } else if (price >= 100000) {
                return `‚Çπ${(price / 100000).toFixed(2)} L`;
            }
            return `‚Çπ${price.toLocaleString('en-IN')}`;
        }
        
        function renderSpecFields() {
            specFieldsContainer.innerHTML = '';
            
            if (currentSearchContext === 'supply') {
                listingHeader.textContent = 'Inventory Listings:';
                // Fields for Supply Search (Exact or Min/Max)
                specFieldsContainer.innerHTML = `
                    <input id="bhk" type="number" class="p-3 border rounded-lg" placeholder="BHK (Exact)">
                    <input id="min_sqft" type="number" class="p-3 border rounded-lg" placeholder="Min Sqft">
                    <input id="max_sqft" type="number" class="p-3 border rounded-lg" placeholder="Max Sqft">
                    <input id="min_price" type="number" class="p-3 border rounded-lg" placeholder="Min Price">
                    <input id="max_price" type="number" class="p-3 border rounded-lg" placeholder="Max Price">
                    <select id="has_lift" class="p-3 border rounded-lg">
                        <option value="">Lift Available?</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                `;
            } else {
                listingHeader.textContent = 'Demand Requests:';
                // Fields for Demand Search (Min/Max Ranges)
                specFieldsContainer.innerHTML = `
                    <input id="bhk_min" type="number" class="p-3 border rounded-lg" placeholder="BHK Min">
                    <input id="bhk_max" type="number" class="p-3 border rounded-lg" placeholder="BHK Max">
                    <input id="area_sqft_min" type="number" class="p-3 border rounded-lg" placeholder="Area Min">
                    <input id="area_sqft_max" type="number" class="p-3 border rounded-lg" placeholder="Area Max">
                    <input id="price_min" type="number" class="p-3 border rounded-lg" placeholder="Budget Min">
                    <input id="price_max" type="number" class="p-3 border rounded-lg" placeholder="Budget Max">
                    <select id="has_lift" class="p-3 border rounded-lg">
                        <option value="">Lift Required?</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                `;
            }
        }

        function setSearchContext(context) {
            currentSearchContext = context;
            renderSpecFields(); // Re-render inputs for the new context
            resultsContainer.innerHTML = ''; // Clear results
            statusMessage.textContent = `Ready to search the ${context} index.`;
            statusMessage.style.display = 'block';
        }

        function renderResults(data) {
            resultsContainer.innerHTML = '';
            statusMessage.style.display = 'none';

            if (!data.hits || data.hits.hits.length === 0) {
                resultsContainer.innerHTML = '<p class="text-red-500 font-semibold">No records found matching your criteria.</p>';
                return;
            }

            const isSupply = currentSearchContext === 'supply';
            
            data.hits.hits.forEach(hit => {
                const p = hit._source;
                const recordId = hit._id;
                
                const title = p.title || p.customer_name || 'Unnamed Record';
                
                // Determine main price display based on context
                const mainPrice = isSupply 
                    ? (p.price ? formatPrice(p.price) : 'N/A')
                    : (p.price_min && p.price_max) ? `${formatPrice(p.price_min)} - ${formatPrice(p.price_max)}` : 'N/A';
                
                // Determine main specs display based on context
                const mainSpecs = isSupply
                    ? `${p.bhk || '?'} BHK ‚Ä¢ ${p.area_sqft || '?'} sqft`
                    : `BHK: ${p.bhk_min || 'Any'} to ${p.bhk_max || 'Any'} ‚Ä¢ Area: ${p.area_sqft_min || 'Any'} sqft`;
                
                const listingBadge = p.listing_type 
                    ? `<span class="inline-block px-2 py-1 ${p.listing_type === 'SALE' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'} text-xs font-medium rounded">${p.listing_type}</span>`
                    : '';
                
                const customerContact = p.customer_email || p.customer_phone || p.customer_name || 'N/A';
                
                const editUrl = `/static/add_update.html?id=${recordId}&context=${currentSearchContext}`;

                const resultCard = `
                    <div class="p-6 border border-gray-200 rounded-xl shadow-md bg-white hover:shadow-lg transition duration-200">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-indigo-800">${title}</h3>
                                <p class="text-xs text-gray-500 mt-1">ID: ${recordId}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-extrabold ${isSupply ? 'text-green-600' : 'text-purple-600'}">${mainPrice}</p>
                                <div class="mt-1">${listingBadge}</div>
                            </div>
                        </div>
                        
                        <p class="text-gray-600 mt-2">üìç **${p.locality || 'N/A'}**</p>
                        <p class="text-gray-700 mt-1">${mainSpecs}</p>
                        
                        <p class="text-sm text-gray-500 mt-3">
                            ${isSupply ? `Seller: ${p.customer_name || 'Unknown'}` : `Requester: ${p.customer_name || 'Unknown'}`} (${customerContact})
                        </p>
                        
                        <div class="mt-4 space-x-3">
                             <a href="${editUrl}" class="text-sm font-medium text-yellow-600 hover:text-yellow-700">‚úèÔ∏è Edit</a>
                             <button onclick="deleteRecord('${recordId}', '${currentSearchContext}')" class="text-sm font-medium text-red-600 hover:text-red-700">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
                resultsContainer.innerHTML += resultCard;
            });
        }

        async function listAll() {
            const endpoint = currentSearchContext; // 'supply' or 'demand'
            statusMessage.textContent = `Fetching all ${endpoint} records...`;
            statusMessage.style.display = 'block';
            resultsContainer.innerHTML = '';
            try {
                const res = await fetch(`${BASE_URL}/${endpoint}/?size=50`);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                renderResults(data);
            } catch (error) {
                statusMessage.textContent = `Error listing records: ${error.message}`;
                statusMessage.className = 'text-red-500 font-semibold';
            }
        }

        async function search() {
            const endpoint = currentSearchContext;
            const params = new URLSearchParams();
            
            // 1. Shared Filters
            const sharedFields = ["locality", "keywords", "title_keywords", "property_type", "listing_type", "furnishing_status"];
            sharedFields.forEach(f => {
                const value = document.getElementById(f).value;
                if (value !== "") params.append(f, value);
            });

            // 2. Contextual Filters (Read dynamically generated fields)
            if (endpoint === 'supply') {
                const supplyFields = ["bhk", "min_sqft", "max_sqft", "min_price", "max_price", "has_lift"];
                supplyFields.forEach(f => {
                    const element = document.getElementById(f);
                    const value = element ? element.value : '';
                    if (value !== "") params.append(f, value);
                });
            } else {
                const demandFields = ["bhk_min", "bhk_max", "area_sqft_min", "area_sqft_max", "price_min", "price_max", "has_lift"];
                 demandFields.forEach(f => {
                    const element = document.getElementById(f);
                    const value = element ? element.value : '';
                    if (value !== "") params.append(f, value);
                });
            }

            statusMessage.textContent = `Searching ${endpoint} index...`;
            statusMessage.style.display = 'block';
            resultsContainer.innerHTML = '';

            try {
                const url = `${BASE_URL}/search/${endpoint}/?${params.toString()}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                renderResults(data);
            } catch (error) {
                statusMessage.textContent = `Error searching records: ${error.message}`;
                statusMessage.className = 'text-red-500 font-semibold';
            }
        }
        
        async function deleteRecord(recordId, context) {
            if (!confirm(`Are you sure you want to delete this ${context} record (${recordId})?`)) return;

            try {
                const res = await fetch(`${BASE_URL}/${context}/${recordId}`, { method: 'DELETE' });
                if (res.status === 404) {
                    alert('Record not found.');
                    return;
                }
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                
                alert(`Record deleted successfully.`);
                listAll();

            } catch (error) {
                alert(`Error deleting record: ${error.message}`);
            }
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            renderSpecFields(); // Render default 'supply' fields
            setSearchContext('supply');
            listAll();
        });
    </script>

</body>
</html>