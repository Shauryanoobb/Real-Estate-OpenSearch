<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page_title">Add New Property</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">

    <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
        <h1 id="form_title" class="text-3xl font-extrabold text-green-700 mb-6 border-b pb-2">‚ûï Add New Property</h1>
        <p class="text-gray-600 mb-6">Fill in the details to list or update the property information.</p>

        <form id="propertyForm" class="space-y-6">
            
            <!-- Hidden field to store the OpenSearch ID when updating (the document ID) -->
            <input type="hidden" id="opensearch_id_hidden">
            
            <div class="border p-4 rounded-xl">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4">Basic Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <!-- ID DISPLAY: Shown only when in Update mode (for reference) -->
                    <div class="col-span-2 hidden mb-4" id="property_id_display"> 
                        <label class="block text-sm font-medium text-gray-700">OpenSearch ID (Cannot be changed)</label>
                        <p id="displayed_property_id" class="p-2 bg-gray-100 border border-gray-300 rounded-md font-mono text-sm"></p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Title</label>
                        <input type="text" id="title" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Property Type</label>
                        <input type="text" id="property_type" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., Apartment, Villa">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Price (‚Çπ)</label>
                        <input type="number" id="price" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="description" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
                </div>
            </div>

            <div class="border p-4 rounded-xl">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4">Location & Specifications</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="locality" required class="col-span-2 p-2 border rounded-md" placeholder="Locality">
                    <input type="text" id="city" class="p-2 border rounded-md" placeholder="City">
                    <input type="text" id="state" class="p-2 border rounded-md" placeholder="State">
                    
                    <input type="number" id="bhk" required class="p-2 border rounded-md" placeholder="BHK">
                    <input type="number" id="bathrooms" required class="p-2 border rounded-md" placeholder="Bathrooms">
                    <input type="number" id="area_sqft" required class="p-2 border rounded-md" placeholder="Area (sqft)">
                    <input type="number" id="floor_number" class="p-2 border rounded-md" placeholder="Floor Number">
                </div>
            </div>

            <div class="border p-4 rounded-xl">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4">Furnishing & Dates</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="furnishing_status" class="p-2 border rounded-md" placeholder="Furnishing Status (e.g. Semi-furnished)">
                    <select id="furnished_or_unfurnished" class="p-2 border rounded-md">
                        <option value="">Is Furnished?</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>

                    <input type="number" id="age_of_building" class="p-2 border rounded-md" placeholder="Age of Building (years)">
                    <select id="lift_available" class="p-2 border rounded-md">
                        <option value="">Lift Available?</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Listed Date</label>
                        <input type="date" id="listed_date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Available From</label>
                        <input type="date" id="available_from" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>

                    <input type="text" id="amenities" class="col-span-2 p-2 border rounded-md" placeholder="Amenities (comma separated: Gym, Pool, Park)">
                </div>
            </div>

            <button type="submit" id="submit_button" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold text-lg hover:bg-green-700 transition duration-150">
                ‚ú® Add Property
            </button>
        </form>

        <div id="response_message" class="mt-6 p-4 rounded-lg text-center font-medium hidden"></div>

        <div class="mt-8 text-center">
            <a href="/static/search_list.html" class="text-indigo-600 hover:text-indigo-800 font-medium">‚Üê Back to Search/List</a>
        </div>
    </div>

    <script>
        const BASE_URL = window.location.origin + "/api/properties";
        const urlParams = new URLSearchParams(window.location.search);
        const propertyIdParam = urlParams.get('id');
        const form = document.getElementById('propertyForm');
        const responseMessage = document.getElementById('response_message');
        const hiddenIdInput = document.getElementById('opensearch_id_hidden');
        const idDisplayGroup = document.getElementById('property_id_display');
        const displayedId = document.getElementById('displayed_property_id');


        // --- Utility Functions for Form Data ---

        function serializeForm() {
            const data = {};
            const fields = [
                "title", "description", "locality", "city", "state",
                "property_type", "furnishing_status", "listed_date", "available_from"
            ];
            const numberFields = [
                "price", "bhk", "bathrooms", "area_sqft", 
                "age_of_building", "floor_number"
            ];
            const booleanFields = ["furnished_or_unfurnished", "lift_available"];

            fields.forEach(f => { data[f] = document.getElementById(f).value || null; });
            
            // Loop for number fields, safely checking for existence and parsing
            numberFields.forEach(f => {
                const element = document.getElementById(f);
                if (element) {
                    const val = element.value;
                    data[f] = val ? parseFloat(val) : null; 
                }
            });
            
            // Loop for boolean fields
            booleanFields.forEach(f => {
                const val = document.getElementById(f).value;
                data[f] = val === "true" ? true : (val === "false" ? false : null);
            });

            // Special handling for amenities
            const amenitiesValue = document.getElementById("amenities").value;
            data.amenities = amenitiesValue ? amenitiesValue.split(",").map(a => a.trim()).filter(a => a) : [];

            // Explicitly set property_id ONLY if we are in Update mode (PUT)
            if (propertyIdParam) {
                 // Send the OpenSearch ID back in the body for Pydantic validation (Optional[str])
                 data.property_id = hiddenIdInput.value; 
            }

            // CRITICAL FIX: Ensure all null/empty values are explicitly deleted 
            // so FastAPI/Pydantic uses defaults or treats them as None, avoiding validation errors 
            // for types like 'Optional[int]' when an empty string is sent.
            Object.keys(data).forEach(key => {
                const value = data[key];
                if (value === null || value === '' || (Array.isArray(value) && value.length === 0)) {
                    delete data[key];
                }
            });

            return data;
        }

        function populateForm(data) {
            const source = data._source || data;
            
            // Set the ID display and hidden input for Update mode
            if (propertyIdParam) {
                hiddenIdInput.value = propertyIdParam; 
                displayedId.textContent = propertyIdParam;
            }
            
            document.getElementById("title").value = source.title || '';
            document.getElementById("description").value = source.description || '';
            document.getElementById("locality").value = source.locality || '';
            document.getElementById("city").value = source.city || '';
            document.getElementById("state").value = source.state || '';
            document.getElementById("price").value = source.price || '';
            document.getElementById("bhk").value = source.bhk || '';
            document.getElementById("bathrooms").value = source.bathrooms || '';
            document.getElementById("area_sqft").value = source.area_sqft || '';
            document.getElementById("furnishing_status").value = source.furnishing_status || '';
            document.getElementById("property_type").value = source.property_type || '';
            document.getElementById("amenities").value = Array.isArray(source.amenities) ? source.amenities.join(', ') : '';
            document.getElementById("listed_date").value = source.listed_date ? source.listed_date.split('T')[0] : '';
            document.getElementById("available_from").value = source.available_from ? source.available_from.split('T')[0] : '';
            document.getElementById("age_of_building").value = source.age_of_building || '';
            document.getElementById("floor_number").value = source.floor_number || '';

            // Handle boolean selects
            document.getElementById("furnished_or_unfurnished").value = source.furnished_or_unfurnished !== undefined && source.furnished_or_unfurnished !== null ? source.furnished_or_unfurnished.toString() : '';
            document.getElementById("lift_available").value = source.lift_available !== undefined && source.lift_available !== null ? source.lift_available.toString() : '';

            // Configuration for Update Mode visibility
            if (propertyIdParam) {
                idDisplayGroup.classList.remove('hidden'); // Show ID on update
            }
        }


        // --- Main Logic ---

        document.addEventListener('DOMContentLoaded', async () => {
            if (propertyIdParam) {
                // Update Mode Setup
                document.getElementById('page_title').textContent = 'Update Property';
                document.getElementById('form_title').textContent = '‚úèÔ∏è Update Property: ' + propertyIdParam;
                document.getElementById('submit_button').textContent = 'üîÑ Update Property';
                document.getElementById('submit_button').classList.replace('bg-green-600', 'bg-indigo-600');
                document.getElementById('submit_button').classList.replace('hover:bg-green-700', 'hover:bg-indigo-700');
                
                try {
                    const res = await fetch(`${BASE_URL}/${propertyIdParam}`);
                    if (res.status === 404) {
                        responseMessage.textContent = 'Property ID not found for update.';
                        responseMessage.className = 'mt-6 p-4 bg-red-100 text-red-700 rounded-lg text-center font-medium block';
                        return;
                    }
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    populateForm(data);
                } catch (error) {
                    responseMessage.textContent = `Error fetching property for update: ${error.message}`;
                    responseMessage.className = 'mt-6 p-4 bg-red-100 text-red-700 rounded-lg text-center font-medium block';
                }
            } else {
                // Addition Mode: Ensure ID field is hidden and clean
                idDisplayGroup.classList.add('hidden');
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check HTML5 validity before proceeding (e.g., ensuring Title, Price, Locality are filled)
            if (!form.checkValidity()) {
                return; 
            }
            
            const formData = serializeForm();
            
            const method = propertyIdParam ? 'PUT' : 'POST';
            const id = propertyIdParam; 
            const url = propertyIdParam ? `${BASE_URL}/${id}` : BASE_URL;
            
            responseMessage.textContent = 'Submitting...';
            responseMessage.className = 'mt-6 p-4 bg-blue-100 text-blue-700 rounded-lg text-center font-medium block';
            responseMessage.style.display = 'block';

            console.log(`--- API Call ---`);
            console.log(`Method: ${method}`);
            console.log(`URL: ${url}`);
            console.log("Payload:", JSON.stringify(formData, null, 2));

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });
                
                const json = await res.json();
                const returnedId = json.opensearch_id || id; 

                if (!res.ok) {
                     console.error("API Request failed. Status:", res.status);
                     console.error("API Response Body (JSON):", json);
                     const errorDetail = json.detail ? JSON.stringify(json.detail) : JSON.stringify(json);
                     throw new Error(`API Error (${res.status}): ${errorDetail}`);
                }

                responseMessage.textContent = `Success! Property ${returnedId} has been ${propertyIdParam ? 'updated' : 'added (ID auto-assigned)'}.`;
                responseMessage.className = 'mt-6 p-4 bg-green-100 text-green-700 rounded-lg text-center font-medium block';

                if (!propertyIdParam) {
                    form.reset(); // Clear form on successful ADD
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                responseMessage.textContent = `Operation Failed: ${error.message}`;
                responseMessage.className = 'mt-6 p-4 bg-red-100 text-red-700 rounded-lg text-center font-medium block';
            }
        });
    </script>
</body>
</html>