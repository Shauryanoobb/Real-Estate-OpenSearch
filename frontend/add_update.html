<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page_title">Add New Property</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">

    <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
        <h1 id="form_title" class="text-3xl font-extrabold text-green-700 mb-6 border-b pb-2">‚ûï Add New Property</h1>
        <p class="text-gray-600 mb-6">Fill in the details to list or update the property information (All fields optional).</p>

        <form id="propertyForm" class="space-y-6">
            
            <!-- Hidden field to store the OpenSearch ID when updating (the document ID) -->
            <input type="hidden" id="opensearch_id_hidden">
            
            <!-- BASIC INFORMATION -->
            <div class="border p-4 rounded-xl">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4">Basic Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <!-- ID DISPLAY: Shown only when in Update mode (for reference) -->
                    <div class="col-span-2 hidden mb-4" id="property_id_display"> 
                        <label class="block text-sm font-medium text-gray-700">OpenSearch ID (Cannot be changed)</label>
                        <p id="displayed_property_id" class="p-2 bg-gray-100 border border-gray-300 rounded-md font-mono text-sm"></p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Title</label>
                        <input type="text" id="title" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    
                    <!-- PROPERTY TYPE (ENUM) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Property Type</label>
                        <select id="property_type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Select Type</option>
                            <option value="Flat">Flat</option>
                            <option value="Bungalow">Bungalow</option>
                            <option value="Plot">Plot</option>
                            <option value="Office">Office</option>
                            <option value="Shop">Shop</option>
                            <option value="Agricultural Land">Agricultural Land</option>
                            <option value="Industrial Land">Industrial Land</option>
                        </select>
                    </div>

                    <!-- NEW: LISTING TYPE (ENUM) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Listing For</label>
                        <select id="listing_type" onchange="toggleDepositField()" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Select Listing Type</option>
                            <option value="SALE">Sale</option>
                            <option value="RENT">Rent</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Price / Rent (‚Çπ)</label>
                        <input type="number" id="price" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>

                    <!-- NEW: DEPOSIT FIELD (CONDITIONAL) -->
                    <div id="deposit_group" class="hidden col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Deposit Amount (‚Çπ)</label>
                        <input type="number" id="deposit" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="description" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
                </div>
            </div>

            <!-- LOCATION & SPECIFICATIONS -->
            <div class="border p-4 rounded-xl">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4">Location & Specifications</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <input type="text" id="locality" class="col-span-full md:col-span-2 p-2 border rounded-md" placeholder="Locality">
                    
                    <input type="number" id="bhk" class="p-2 border rounded-md" placeholder="BHK">
                    <input type="number" id="bathrooms" class="p-2 border rounded-md" placeholder="Bathrooms">
                    <input type="number" id="area_sqft" class="p-2 border rounded-md" placeholder="Area (sqft)">
                    <input type="text" id="facing_direction" class="p-2 border rounded-md" placeholder="Facing Direction">
                    
                    <input type="number" id="floor_number" class="p-2 border rounded-md" placeholder="Floor Number">
                    <input type="number" id="total_floors" class="p-2 border rounded-md" placeholder="Total Floors">
                    
                    <!-- ADDITIONAL ROOMS (Multi-Select) -->
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Additional Rooms (Ctrl/Cmd + Click)</label>
                        <select id="additional_rooms" multiple class="w-full p-2 border rounded-md h-24" size="4">
                            <option value="Store Room">Store Room</option>
                            <option value="Study Room">Study Room</option>
                            <option value="Servant Room">Servant Room</option>
                            <option value="Pooja Room">Pooja Room</option>
                        </select>
                    </div>

                    <!-- OVERLOOKING (Multi-Select) -->
                    <div class="col-span-2">
                         <label class="block text-sm font-medium text-gray-700">Overlooking View (Ctrl/Cmd + Click)</label>
                        <select id="overlooking" multiple class="w-full p-2 border rounded-md h-24" size="4">
                            <option value="Park">Park View</option>
                            <option value="Main Road">Main Road</option>
                            <option value="Garden">Garden View</option>
                            <option value="Pool">Pool View</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- FURNISHING & DATES -->
            <div class="border p-4 rounded-xl">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4">Furnishing & Dates</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    
                    <!-- FURNISHING STATUS (ENUM) -->
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Furnishing Status</label>
                        <select id="furnishing_status" class="w-full p-2 border rounded-md">
                            <option value="">Select Status</option>
                            <option value="FURNISHED">FURNISHED</option>
                            <option value="SEMI_FURNISHED">SEMI-FURNISHED</option>
                            <option value="UNFURNISHED">UNFURNISHED</option>
                        </select>
                    </div>
                    
                    <input type="number" id="age_of_building" class="p-2 border rounded-md" placeholder="Age of Building (years)">
                    
                    <select id="lift_available" class="p-2 border rounded-md">
                        <option value="">Lift Available?</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>

                    <input type="text" id="amenities" class="col-span-full p-2 border rounded-md" placeholder="Amenities (comma separated: Gym, Pool, Park)">
                    <input type="text" id="images" class="col-span-full p-2 border rounded-md" placeholder="Image URLs (comma separated)">

                    <div class="col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Listed Date</label>
                        <input type="date" id="listed_date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>
            </div>
            
            <!-- SELLER DETAILS -->
            <div class="border p-4 rounded-xl">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4">Seller Details (Source of Truth)</h2>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="seller_name" class="p-2 border rounded-md" placeholder="Seller Name">
                    <input type="email" id="seller_email" class="p-2 border rounded-md" placeholder="Seller Email">
                    <input type="tel" id="seller_phone" class="p-2 border rounded-md" placeholder="Seller Phone">
                    <input type="text" id="seller_referred_by" class="p-2 border rounded-md" placeholder="Referred By">
                    
                    <input type="text" id="seller_address" class="col-span-full p-2 border rounded-md" placeholder="Seller Address">
                    <textarea id="seller_additional_info" rows="2" class="col-span-full p-2 border rounded-md" placeholder="Seller Additional Notes"></textarea>
                </div>
            </div>

            <button type="submit" id="submit_button" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold text-lg hover:bg-green-700 transition duration-150">
                ‚ú® Add Property
            </button>
        </form>

        <div id="response_message" class="mt-6 p-4 rounded-lg text-center font-medium hidden"></div>

        <div class="mt-8 text-center">
            <a href="/static/search_list.html" class="text-indigo-600 hover:text-indigo-800 font-medium">‚Üê Back to Search/List</a>
        </div>
    </div>

    <script>
        const BASE_URL = window.location.origin + "/api/properties";
        const urlParams = new URLSearchParams(window.location.search);
        const propertyIdParam = urlParams.get('id');
        const form = document.getElementById('propertyForm');
        const responseMessage = document.getElementById('response_message');
        const hiddenIdInput = document.getElementById('opensearch_id_hidden');
        const idDisplayGroup = document.getElementById('property_id_display');
        const displayedId = document.getElementById('displayed_property_id');
        const depositGroup = document.getElementById('deposit_group'); 

        // Helper function to show/hide the Deposit field based on Listing Type
        function toggleDepositField() {
            const listingType = document.getElementById('listing_type').value;
            if (listingType === 'RENT') {
                depositGroup.classList.remove('hidden');
            } else {
                depositGroup.classList.add('hidden');
                document.getElementById('deposit').value = ''; // Clear value if hidden
            }
        }
        
        // Helper function to get selected options from a multiple select element
        function getMultiSelectValues(id) {
            const select = document.getElementById(id);
            if (!select) return [];
            return Array.from(select.selectedOptions).map(option => option.value);
        }

        function serializeForm() {
            const data = {};
            const fields = [
                "title", "description", "locality", "facing_direction",
                "property_type", "listing_type", "furnishing_status", "listed_date",
                // Seller Fields
                "seller_name", "seller_email", "seller_phone", "seller_address", "seller_referred_by", "seller_additional_info"
            ];
            const numberFields = [
                "price", "deposit", "bhk", "bathrooms", "area_sqft",
                "age_of_building", "floor_number", "total_floors"
            ];
            const booleanFields = ["lift_available"];

            fields.forEach(f => { 
                const element = document.getElementById(f);
                if (element) data[f] = element.value || null; 
            });
            
            // Loop for number fields, safely checking for existence and parsing
            numberFields.forEach(f => {
                const element = document.getElementById(f);
                if (element) {
                    const val = element.value;
                    data[f] = val ? parseFloat(val) : null; 
                }
            });
            
            // Loop for boolean fields
            booleanFields.forEach(f => {
                const val = document.getElementById(f).value;
                data[f] = val === "true" ? true : (val === "false" ? false : null);
            });

            // Handle Array/List Fields
            const amenitiesValue = document.getElementById("amenities").value;
            data.amenities = amenitiesValue ? amenitiesValue.split(",").map(a => a.trim()).filter(a => a) : [];
            
            const imagesValue = document.getElementById("images").value;
            data.images = imagesValue ? imagesValue.split(",").map(a => a.trim()).filter(a => a) : [];

            // Handle Multi-Select Enum Fields
            data.overlooking = getMultiSelectValues('overlooking');
            data.additional_rooms = getMultiSelectValues('additional_rooms');


            // Explicitly set property_id ONLY if we are in Update mode (PUT)
            if (propertyIdParam) {
                 data.property_id = hiddenIdInput.value; 
            }

            // CRITICAL FIX: Ensure all null/empty values are explicitly deleted 
            Object.keys(data).forEach(key => {
                const value = data[key];
                // Check if deposit is being passed, if it's 0 it should remain, but if it's null/empty string/empty array delete it
                if (key !== 'deposit' && (value === null || value === '' || (Array.isArray(value) && value.length === 0))) {
                    delete data[key];
                }
            });

            return data;
        }

        function setMultiSelectValues(id, values) {
            const select = document.getElementById(id);
            if (select && Array.isArray(values)) {
                Array.from(select.options).forEach(option => {
                    option.selected = values.includes(option.value);
                });
            }
        }

        function populateForm(data) {
            const source = data._source || data;
            
            // Set the ID display and hidden input for Update mode
            if (propertyIdParam) {
                hiddenIdInput.value = propertyIdParam; 
                displayedId.textContent = propertyIdParam;
            }
            
            // Basic Fields
            document.getElementById("title").value = source.title || '';
            document.getElementById("description").value = source.description || '';
            document.getElementById("locality").value = source.locality || '';
            
            // NEW FIELDS
            document.getElementById("listing_type").value = source.listing_type || '';
            document.getElementById("deposit").value = source.deposit || ''; // Populate deposit if it exists

            document.getElementById("price").value = source.price || '';
            document.getElementById("bhk").value = source.bhk || '';
            document.getElementById("bathrooms").value = source.bathrooms || '';
            document.getElementById("area_sqft").value = source.area_sqft || '';
            document.getElementById("facing_direction").value = source.facing_direction || '';
            document.getElementById("floor_number").value = source.floor_number || '';
            document.getElementById("total_floors").value = source.total_floors || '';
            document.getElementById("age_of_building").value = source.age_of_building || '';
            document.getElementById("listed_date").value = source.listed_date ? source.listed_date.split('T')[0] : '';
            
            // Seller Fields
            document.getElementById("seller_name").value = source.seller_name || '';
            document.getElementById("seller_email").value = source.seller_email || '';
            document.getElementById("seller_phone").value = source.seller_phone || '';
            document.getElementById("seller_address").value = source.seller_address || '';
            document.getElementById("seller_referred_by").value = source.seller_referred_by || '';
            document.getElementById("seller_additional_info").value = source.seller_additional_info || '';
            
            // Enum Selects (Single Value)
            document.getElementById("property_type").value = source.property_type || '';
            document.getElementById("furnishing_status").value = source.furnishing_status || '';
            
            // Boolean Selects
            document.getElementById("lift_available").value = source.lift_available !== undefined && source.lift_available !== null ? source.lift_available.toString() : '';

            // Array Fields (Single Input)
            document.getElementById("amenities").value = Array.isArray(source.amenities) ? source.amenities.join(', ') : '';
            document.getElementById("images").value = Array.isArray(source.images) ? source.images.join(', ') : '';

            // Array/Enum Multi-Selects
            setMultiSelectValues('overlooking', source.overlooking);
            setMultiSelectValues('additional_rooms', source.additional_rooms);

            // CRITICAL: Call toggleDepositField AFTER setting listing_type to ensure visibility is correct
            toggleDepositField(); 

            // Configuration for Update Mode visibility
            if (propertyIdParam) {
                idDisplayGroup.classList.remove('hidden'); // Show ID on update
            }
        }


        // --- Main Logic (Submit Handler remains unchanged) ---

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize visibility in case we are in Add mode or Sale mode
            toggleDepositField(); 

            if (propertyIdParam) {
                // Update Mode Setup
                document.getElementById('page_title').textContent = 'Update Property';
                document.getElementById('form_title').textContent = '‚úèÔ∏è Update Property: ' + propertyIdParam;
                document.getElementById('submit_button').textContent = 'üîÑ Update Property';
                document.getElementById('submit_button').classList.replace('bg-green-600', 'bg-indigo-600');
                document.getElementById('submit_button').classList.replace('hover:bg-green-700', 'hover:bg-indigo-700');
                
                try {
                    const res = await fetch(`${BASE_URL}/${propertyIdParam}`);
                    if (res.status === 404) {
                        responseMessage.textContent = 'Property ID not found for update.';
                        responseMessage.className = 'mt-6 p-4 bg-red-100 text-red-700 rounded-lg text-center font-medium block';
                        return;
                    }
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    populateForm(data);
                } catch (error) {
                    responseMessage.textContent = `Error fetching property for update: ${error.message}`;
                    responseMessage.className = 'mt-6 p-4 bg-red-100 text-red-700 rounded-lg text-center font-medium block';
                }
            } else {
                // Addition Mode: Ensure ID field is hidden and clean
                idDisplayGroup.classList.add('hidden');
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check HTML5 validity before proceeding 
            // NOTE: form.checkValidity() will now only check fields with the 'required' attribute, 
            // which are currently none in the current HTML.
            if (!form.checkValidity()) {
                return; 
            }
            
            const formData = serializeForm();
            
            const method = propertyIdParam ? 'PUT' : 'POST';
            const id = propertyIdParam; 
            const url = propertyIdParam ? `${BASE_URL}/${id}` : BASE_URL;
            
            responseMessage.textContent = 'Submitting...';
            responseMessage.className = 'mt-6 p-4 bg-blue-100 text-blue-700 rounded-lg text-center font-medium block';
            responseMessage.style.display = 'block';

            console.log(`--- API Call ---`);
            console.log(`Method: ${method}`);
            console.log(`URL: ${url}`);
            console.log("Payload:", JSON.stringify(formData, null, 2));

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });
                
                const json = await res.json();
                const returnedId = json.opensearch_id || id; 

                if (!res.ok) {
                     console.error("API Request failed. Status:", res.status);
                     console.error("API Response Body (JSON):", json);
                     const errorDetail = json.detail ? JSON.stringify(json.detail) : JSON.stringify(json);
                     throw new Error(`API Error (${res.status}): ${errorDetail}`);
                }

                responseMessage.textContent = `Success! Property ${returnedId} has been ${propertyIdParam ? 'updated' : 'added (ID auto-assigned)'}.`;
                responseMessage.className = 'mt-6 p-4 bg-green-100 text-green-700 rounded-lg text-center font-medium block';

                if (!propertyIdParam) {
                    form.reset(); // Clear form on successful ADD
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                responseMessage.textContent = `Operation Failed: ${error.message}`;
                responseMessage.className = 'mt-6 p-4 bg-red-100 text-red-700 rounded-lg text-center font-medium block';
            }
        });
    </script>
</body>
</html>