<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page_title">Add New Property</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-4 sm:p-6">

    <div class="max-w-4xl mx-auto bg-white p-4 sm:p-8 rounded-2xl shadow-xl">
        <h1 id="form_title" class="text-2xl sm:text-3xl font-extrabold text-green-700 mb-4 sm:mb-6 border-b pb-2">‚ûï Add New Property</h1>
        <p class="text-gray-600 mb-4 sm:mb-6 text-sm sm:text-base">Fill in the details to list or update the property information.</p>

        <form id="propertyForm" class="space-y-4 sm:space-y-6">
            
            <!-- Hidden field to store the OpenSearch ID when updating (the document ID) -->
            <input type="hidden" id="opensearch_id_hidden">
            
            <!-- BASIC INFORMATION -->
            <div class="border p-3 sm:p-4 rounded-xl">
                <h2 class="text-lg sm:text-xl font-semibold text-indigo-600 mb-3 sm:mb-4">Basic Information</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                    
                    <!-- ID DISPLAY: Shown only when in Update mode (for reference) -->
                    <div class="col-span-full hidden mb-4" id="property_id_display"> 
                        <label class="block text-sm font-medium text-gray-700">OpenSearch ID (Cannot be changed)</label>
                        <p id="displayed_property_id" class="p-2 bg-gray-100 border border-gray-300 rounded-md font-mono text-sm break-all"></p>
                    </div>
                    
                    <div class="col-span-full">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                        <input type="text" id="title" required class="block w-full p-2 border border-gray-300 rounded-md text-sm sm:text-base">
                    </div>
                    
                    <!-- PROPERTY TYPE (ENUM) -->
                    <div class="col-span-full sm:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Property Type *</label>
                        <select id="property_type" required class="block w-full p-2 border border-gray-300 rounded-md text-sm sm:text-base">
                            <option value="">Select Type</option>
                            <option value="Flat">Flat</option>
                            <option value="Bungalow">Bungalow</option>
                            <option value="Plot">Plot</option>
                            <option value="Office">Office</option>
                            <option value="Shop">Shop</option>
                        </select>
                    </div>

                    <div class="col-span-full sm:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Price (‚Çπ) *</label>
                        <input type="number" id="price" required class="block w-full p-2 border border-gray-300 rounded-md text-sm sm:text-base">
                    </div>
                </div>
                <div class="mt-3 sm:mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="description" rows="3" class="block w-full p-2 border border-gray-300 rounded-md text-sm sm:text-base"></textarea>
                </div>
            </div>

            <!-- LOCATION & SPECIFICATIONS -->
            <div class="border p-3 sm:p-4 rounded-xl">
                <h2 class="text-lg sm:text-xl font-semibold text-indigo-600 mb-3 sm:mb-4">Location & Specifications</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                    <div class="col-span-full sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Locality *</label>
                        <input type="text" id="locality" required class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="Locality">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">BHK *</label>
                        <input type="number" id="bhk" required class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="BHK">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bathrooms *</label>
                        <input type="number" id="bathrooms" required class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="Bathrooms">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Area (sqft) *</label>
                        <input type="number" id="area_sqft" required class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="Area">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Facing Direction</label>
                        <input type="text" id="facing_direction" class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="e.g., North">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Floor Number</label>
                        <input type="number" id="floor_number" class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="Floor">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Floors</label>
                        <input type="number" id="total_floors" class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="Total">
                    </div>
                    
                    <!-- ADDITIONAL ROOMS (Multi-Select) -->
                    <div class="col-span-full sm:col-span-2 lg:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Additional Rooms</label>
                        <p class="text-xs text-gray-500 mb-2">Hold Ctrl/Cmd and click to select multiple</p>
                        <div class="border border-gray-300 rounded-md p-2 bg-white max-h-32 overflow-y-auto">
                            <select id="additional_rooms" multiple class="w-full border-none focus:ring-0 text-sm" size="4">
                                <option value="Store Room">Store Room</option>
                                <option value="Study Room">Study Room</option>
                                <option value="Servant Room">Servant Room</option>
                                <option value="Pooja Room">Pooja Room</option>
                            </select>
                        </div>
                    </div>

                    <!-- OVERLOOKING (Multi-Select) -->
                    <div class="col-span-full sm:col-span-2 lg:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Overlooking View</label>
                        <p class="text-xs text-gray-500 mb-2">Hold Ctrl/Cmd and click to select multiple</p>
                        <div class="border border-gray-300 rounded-md p-2 bg-white max-h-32 overflow-y-auto">
                            <select id="overlooking" multiple class="w-full border-none focus:ring-0 text-sm" size="4">
                                <option value="Park">Park View</option>
                                <option value="Main Road">Main Road</option>
                                <option value="Garden">Garden View</option>
                                <option value="Pool">Pool View</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FURNISHING & DATES -->
            <div class="border p-3 sm:p-4 rounded-xl">
                <h2 class="text-lg sm:text-xl font-semibold text-indigo-600 mb-3 sm:mb-4">Furnishing & Dates</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                    
                    <!-- FURNISHING STATUS (ENUM) -->
                    <div class="col-span-full sm:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Furnishing Status</label>
                        <select id="furnishing_status" class="block w-full p-2 border rounded-md text-sm sm:text-base">
                            <option value="">Select Status</option>
                            <option value="FURNISHED">FURNISHED</option>
                            <option value="SEMI_FURNISHED">SEMI-FURNISHED</option>
                            <option value="UNFURNISHED">UNFURNISHED</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Building Age (years)</label>
                        <input type="number" id="age_of_building" class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="Age">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Lift Available?</label>
                        <select id="lift_available" class="block w-full p-2 border rounded-md text-sm sm:text-base">
                            <option value="">Select</option>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>

                    <div class="col-span-full sm:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Listed Date</label>
                        <input type="date" id="listed_date" class="block w-full p-2 border border-gray-300 rounded-md text-sm sm:text-base">
                    </div>

                    <div class="col-span-full">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Amenities</label>
                        <input type="text" id="amenities" class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="Gym, Pool, Park (comma separated)">
                    </div>
                    
                    <div class="col-span-full">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Image URLs</label>
                        <input type="text" id="images" class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="https://example.com/image1.jpg, https://... (comma separated)">
                    </div>
                </div>
            </div>
            
            <!-- SELLER DETAILS -->
            <div class="border p-3 sm:p-4 rounded-xl">
                <h2 class="text-lg sm:text-xl font-semibold text-indigo-600 mb-3 sm:mb-4">Seller Details</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Seller Name</label>
                        <input type="text" id="seller_name" class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="Name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Seller Email</label>
                        <input type="email" id="seller_email" class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="email@example.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Seller Phone</label>
                        <input type="tel" id="seller_phone" class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="Phone">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Referred By</label>
                        <input type="text" id="seller_referred_by" class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="Referrer">
                    </div>
                    
                    <div class="col-span-full">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Seller Address</label>
                        <input type="text" id="seller_address" class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="Address">
                    </div>
                    
                    <div class="col-span-full">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
                        <textarea id="seller_additional_info" rows="2" class="block w-full p-2 border rounded-md text-sm sm:text-base" placeholder="Any additional information"></textarea>
                    </div>
                </div>
            </div>

            <button type="submit" id="submit_button" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold text-base sm:text-lg hover:bg-green-700 transition duration-150">
                ‚ú® Add Property
            </button>
        </form>

        <div id="response_message" class="mt-4 sm:mt-6 p-3 sm:p-4 rounded-lg text-center font-medium hidden text-sm sm:text-base"></div>

        <div class="mt-6 sm:mt-8 text-center">
            <a href="/static/search_list.html" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm sm:text-base">‚Üê Back to Search/List</a>
        </div>
    </div>

    <script>
        const BASE_URL = window.location.origin + "/api/properties";
        const urlParams = new URLSearchParams(window.location.search);
        const propertyIdParam = urlParams.get('id');
        const form = document.getElementById('propertyForm');
        const responseMessage = document.getElementById('response_message');
        const hiddenIdInput = document.getElementById('opensearch_id_hidden');
        const idDisplayGroup = document.getElementById('property_id_display');
        const displayedId = document.getElementById('displayed_property_id');

        // Helper function to get selected options from a multiple select element
        function getMultiSelectValues(id) {
            const select = document.getElementById(id);
            if (!select) return [];
            return Array.from(select.selectedOptions).map(option => option.value);
        }

        function serializeForm() {
            const data = {};
            const fields = [
                "title", "description", "locality", "facing_direction",
                "property_type", "furnishing_status", "listed_date",
                // Seller Fields
                "seller_name", "seller_email", "seller_phone", "seller_address", "seller_referred_by", "seller_additional_info"
            ];
            const numberFields = [
                "price", "bhk", "bathrooms", "area_sqft", 
                "age_of_building", "floor_number", "total_floors"
            ];
            const booleanFields = ["lift_available"];

            fields.forEach(f => { data[f] = document.getElementById(f).value || null; });
            
            // Loop for number fields, safely checking for existence and parsing
            numberFields.forEach(f => {
                const element = document.getElementById(f);
                if (element) {
                    const val = element.value;
                    data[f] = val ? parseFloat(val) : null; 
                }
            });
            
            // Loop for boolean fields
            booleanFields.forEach(f => {
                const val = document.getElementById(f).value;
                data[f] = val === "true" ? true : (val === "false" ? false : null);
            });

            // Handle Array/List Fields
            const amenitiesValue = document.getElementById("amenities").value;
            data.amenities = amenitiesValue ? amenitiesValue.split(",").map(a => a.trim()).filter(a => a) : [];
            
            const imagesValue = document.getElementById("images").value;
            data.images = imagesValue ? imagesValue.split(",").map(a => a.trim()).filter(a => a) : [];

            // Handle Multi-Select Enum Fields
            data.overlooking = getMultiSelectValues('overlooking');
            data.additional_rooms = getMultiSelectValues('additional_rooms');


            // Explicitly set property_id ONLY if we are in Update mode (PUT)
            if (propertyIdParam) {
                 data.property_id = hiddenIdInput.value; 
            }

            // CRITICAL FIX: Ensure all null/empty values are explicitly deleted 
            Object.keys(data).forEach(key => {
                const value = data[key];
                if (value === null || value === '' || (Array.isArray(value) && value.length === 0)) {
                    delete data[key];
                }
            });

            return data;
        }

        function setMultiSelectValues(id, values) {
            const select = document.getElementById(id);
            if (select && Array.isArray(values)) {
                Array.from(select.options).forEach(option => {
                    option.selected = values.includes(option.value);
                });
            }
        }

        function populateForm(data) {
            const source = data._source || data;
            
            // Set the ID display and hidden input for Update mode
            if (propertyIdParam) {
                hiddenIdInput.value = propertyIdParam; 
                displayedId.textContent = propertyIdParam;
            }
            
            // Basic Fields
            document.getElementById("title").value = source.title || '';
            document.getElementById("description").value = source.description || '';
            document.getElementById("locality").value = source.locality || '';
            document.getElementById("price").value = source.price || '';
            document.getElementById("bhk").value = source.bhk || '';
            document.getElementById("bathrooms").value = source.bathrooms || '';
            document.getElementById("area_sqft").value = source.area_sqft || '';
            document.getElementById("facing_direction").value = source.facing_direction || '';
            document.getElementById("floor_number").value = source.floor_number || '';
            document.getElementById("total_floors").value = source.total_floors || '';
            document.getElementById("age_of_building").value = source.age_of_building || '';
            document.getElementById("listed_date").value = source.listed_date ? source.listed_date.split('T')[0] : '';
            
            // Seller Fields
            document.getElementById("seller_name").value = source.seller_name || '';
            document.getElementById("seller_email").value = source.seller_email || '';
            document.getElementById("seller_phone").value = source.seller_phone || '';
            document.getElementById("seller_address").value = source.seller_address || '';
            document.getElementById("seller_referred_by").value = source.seller_referred_by || '';
            document.getElementById("seller_additional_info").value = source.seller_additional_info || '';
            
            // Enum Selects (Single Value)
            document.getElementById("property_type").value = source.property_type || '';
            document.getElementById("furnishing_status").value = source.furnishing_status || '';
            
            // Boolean Selects
            document.getElementById("lift_available").value = source.lift_available !== undefined && source.lift_available !== null ? source.lift_available.toString() : '';

            // Array Fields (Single Input)
            document.getElementById("amenities").value = Array.isArray(source.amenities) ? source.amenities.join(', ') : '';
            document.getElementById("images").value = Array.isArray(source.images) ? source.images.join(', ') : '';

            // Array/Enum Multi-Selects
            setMultiSelectValues('overlooking', source.overlooking);
            setMultiSelectValues('additional_rooms', source.additional_rooms);


            // Configuration for Update Mode visibility
            if (propertyIdParam) {
                idDisplayGroup.classList.remove('hidden'); // Show ID on update
            }
        }


        // --- Main Logic (Submit Handler remains unchanged) ---

        document.addEventListener('DOMContentLoaded', async () => {
            if (propertyIdParam) {
                // Update Mode Setup
                document.getElementById('page_title').textContent = 'Update Property';
                document.getElementById('form_title').textContent = '‚úèÔ∏è Update Property: ' + propertyIdParam;
                document.getElementById('submit_button').textContent = 'üîÑ Update Property';
                document.getElementById('submit_button').classList.replace('bg-green-600', 'bg-indigo-600');
                document.getElementById('submit_button').classList.replace('hover:bg-green-700', 'hover:bg-indigo-700');
                
                try {
                    const res = await fetch(`${BASE_URL}/${propertyIdParam}`);
                    if (res.status === 404) {
                        responseMessage.textContent = 'Property ID not found for update.';
                        responseMessage.className = 'mt-6 p-4 bg-red-100 text-red-700 rounded-lg text-center font-medium block';
                        return;
                    }
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    populateForm(data);
                } catch (error) {
                    responseMessage.textContent = `Error fetching property for update: ${error.message}`;
                    responseMessage.className = 'mt-6 p-4 bg-red-100 text-red-700 rounded-lg text-center font-medium block';
                }
            } else {
                // Addition Mode: Ensure ID field is hidden and clean
                idDisplayGroup.classList.add('hidden');
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check HTML5 validity before proceeding 
            if (!form.checkValidity()) {
                return; 
            }
            
            const formData = serializeForm();
            
            const method = propertyIdParam ? 'PUT' : 'POST';
            const id = propertyIdParam; 
            const url = propertyIdParam ? `${BASE_URL}/${id}` : BASE_URL;
            
            responseMessage.textContent = 'Submitting...';
            responseMessage.className = 'mt-6 p-4 bg-blue-100 text-blue-700 rounded-lg text-center font-medium block';
            responseMessage.style.display = 'block';

            console.log(`--- API Call ---`);
            console.log(`Method: ${method}`);
            console.log(`URL: ${url}`);
            console.log("Payload:", JSON.stringify(formData, null, 2));

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });
                
                const json = await res.json();
                const returnedId = json.opensearch_id || id; 

                if (!res.ok) {
                     console.error("API Request failed. Status:", res.status);
                     console.error("API Response Body (JSON):", json);
                     const errorDetail = json.detail ? JSON.stringify(json.detail) : JSON.stringify(json);
                     throw new Error(`API Error (${res.status}): ${errorDetail}`);
                }

                responseMessage.textContent = `Success! Property ${returnedId} has been ${propertyIdParam ? 'updated' : 'added (ID auto-assigned)'}.`;
                responseMessage.className = 'mt-6 p-4 bg-green-100 text-green-700 rounded-lg text-center font-medium block';

                if (!propertyIdParam) {
                    form.reset(); // Clear form on successful ADD
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                responseMessage.textContent = `Operation Failed: ${error.message}`;
                responseMessage.className = 'mt-6 p-4 bg-red-100 text-red-700 rounded-lg text-center font-medium block';
            }
        });
    </script>
</body>
</html>